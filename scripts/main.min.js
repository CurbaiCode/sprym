var lang="en",translation=!1,libraryCache,collectionCache,bookCache,partCache,noteCache,curCollection,curBook,curPart,curChapter,contentTouch=readerTouch=modalTouch={};function mode(n){n&&document.body.setAttribute("data-theme",n)}function modeHandler(n){var t=localStorage.getItem("theme")||(n.matches?"dark":"light");mode(t)}var modeMQ=window.matchMedia("(prefers-color-scheme: dark)");modeMQ.addEventListener?modeMQ.addEventListener("change",modeHandler):modeMQ.addListener(modeHandler),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&mode("dark"),mode(localStorage.getItem("theme"));var short=!1;function shortHandler(n){short=!!n.matches}var shortMQ=window.matchMedia("(max-width: 400px)");shortMQ.addEventListener?shortMQ.addEventListener("change",shortHandler):shortMQ.addListener(shortHandler),window.matchMedia&&window.matchMedia("(max-width: 400px)").matches&&(short=!0),libCatalog();var reader=document.getElementById("reader");reader.addEventListener("scroll",function(){document.getElementById("progress").style.width=Math.min(Math.max(reader.scrollTop/(reader.scrollHeight-reader.clientHeight),0),1)*100+"%"});function readBinaryFile(n,t){var e=new XMLHttpRequest;e.responseType="arraybuffer",e.open("GET",n,!0),e.addEventListener("load",function(){if(e.status>=200&&e.status<300)try{t(!0,msgpackr.unpack(e.response))}catch(a){t(!1,!0)}else t(!1)}),e.send(null)}function readFile(n,t){var e=new XMLHttpRequest;e.open("GET",n,!0),e.addEventListener("load",function(){e.status>=200&&e.status<300?t(!0,e.responseText):t(!1)}),e.send(null)}function readLines(n,t,e){var a=new XMLHttpRequest;a.open("GET",n,!0),a.addEventListener("load",function(){if(a.status>=200&&a.status<300){var r=a.responseText.replace(/\n\n/g,`
`).replace(/~([^\^]+)\/\^/g,"").replace(/\^/g,"").split(`
`);e(!0,t.map(function(l){return r[l-1]}))}else e(!1)}),a.send(null)}function ordinal(n){for(var t=97,e=122-t+1,a="";n>=0;)a=String.fromCharCode(n%e+t)+a,n=Math.floor(n/e)-1;return a}function integer(n){for(var t=97,e=122-t+1,a=0,r=0;r<n.length;r++){var l=n.charCodeAt(r)-t;a=a*e+l}return a}function parse(n,t,e){if(t=="verse"){document.getElementById("reader").classList="verse";var a=1;for(var r of e.split(/\n(?![^\^]*\/\^)/g))if(r!=""){var l=document.createElement("li");l.id="p"+a;for(var i=0;match=/<\|([^>]+)>/g.exec(r);)r=r.replace(match[0],"`|"+match[1]+"`");for(var c=r;match=/(?:<([^>]+)>)|(?:\^([^\^]+)\/\^)/g.exec(r);){var o=ordinal(i),d="<sup>"+o+"</sup>";if(match[2]){for(var u=0,m=match[2];submatch=/<([^>]+)>/g.exec(match[2]);)match[2].split("~")[0].startsWith("<")&&(m=m.replace(submatch[0],submatch[1]),match[2]=match[2].replace(submatch[0],"")),++u,o=ordinal(i+u),d="<sup>"+o+"</sup>",submatch[1].startsWith("|")?(--u,m=m.replace(submatch[0],"<em>"+submatch[1].slice(1)+"</em>")):m=m.replace(submatch[0],'<span id="n'+a+o+'" onclick="note(this)">'+d+submatch[1]+"</span>"),match[2]=match[2].replace(submatch[0],"");o=ordinal(i),d="<sup>"+o+"</sup>";var s=m.split("~")[0],g=s.split(`
`).length;if(translation){s=m.split("~")[1];var k=s.split(`
`).length}for(;emMatch=/`([^\|]+?)`[^\|]/g.exec(s);)s=s.replace(emMatch[0],'<em class="jst">'+emMatch[1]+"</em>");var E=!0,f=0;for(var h of s.split(`
`)){++f,E?E=!1:(f<=g?s=s.replace(h,'<li id="p'+(a+f-1)+'"><span>'+h+"</span></li>"):s=s.replace(h,"<li><span>"+h+"</span></li>"),i=0);for(var C=!0,B=0,x=1,p=h,v=h;idMatch=/( id="n)[0-9]*?([a-z]*?)(" onclick="note\(this\)"><sup>)[a-z]*?(<\/sup>)/g.exec(v);){++x,C&&(C=!1,B=integer(idMatch[2]));var y=x-B;y<0&&(y=0);var I=ordinal(y);p=p.replace(idMatch[0],idMatch[1]+(a+f-1)+I+idMatch[3]+I+idMatch[4]),v=v.replace(idMatch[0],"")}s=s.replace(h,p)}if(o=ordinal(i),d="<sup>"+o+"</sup>",translation)c=c.replace(match[0],'<span id="n'+a+o+'">'+d+s+"</span>");else{s=s.split(/ (?![^<]*>)/g);var b='<span id="n'+a+o+'" onclick="note(this)">'+d+s[0]+"</span>";s[0]="",c=c.replace(match[0],b+s.join(" "))}i=i+u,l.id="p"+a,a=a+f-1,translation&&(a=a-(k-g))}else c=c.replace(match[0],'<span id="n'+a+o+'" onclick="note(this)">'+d+match[1]+"</span>");r=r.replace(match[0],""),++i}for(;match=/`\|([^`]+)`/g.exec(c);)c=c.replace(match[0],"<em>"+match[1]+"</em>");l.innerHTML=c,n.appendChild(l),a++}else n.appendChild(document.createElement("br"))}else n.textContent=e}var back=document.getElementById("back"),backLabel=document.getElementById("back-label"),title=document.getElementById("title"),pages=document.getElementById("content").children,tabs=document.getElementById("nav").children,alertInfo=document.getElementById("alert-info"),alertBtns=document.getElementById("alert-btns");function notify(n,t,e,a){switch(document.getElementById("alert-title").textContent=t,e){case"":alertInfo.style.display="none",alertInfo.textContent="";break;default:alertInfo.textContent=e,alertInfo.style.display=""}alertBtns.innerHTML="";for(var r in a){var l=document.createElement("button");l.textContent=r;var i=a[r];i||(i=function(){document.body.classList.remove("alert")}),l.addEventListener("click",i),alertBtns.appendChild(l)}document.body.classList.add("alert")}function swap(n,t,e){n.classList.add("swapping"),setTimeout(function(){n.textContent=t,n.classList.remove("swapping")},e*500)}function setBack(n,t,e){e=e||"",e=="button"&&(back.style.opacity="0"),back.onclick=n,swap(backLabel,t,.35),e==""&&(back.style.opacity="")}function closeInspector(n){n&&!n.target.closest("#inspector, #back")?(document.getElementById("content").removeEventListener("click",closeInspector),back.click()):n||document.getElementById("content").removeEventListener("click",closeInspector)}function slide(n,t,e,a){if(a=a!=null?a:!0,document.getElementById("progress").style.opacity="",t)for(var r=0;r<tabs.length;r++)tabs[r].id==t+"-tab"?tabs[r].classList.add("active"):tabs[r].classList.remove("active");else for(var r=0;r<tabs.length;r++)tabs[r].classList.remove("active");for(var l=!0,r=0;r<pages.length;r++)pages[r].id==n&&(l=!1),l?pages[r].classList.add("hidden"):pages[r].classList.remove("hidden");switch(n){case"home":setBack(function(){},"","button"),document.title="Sprym",swap(title,"Home",.35);break;case"library":setBack(function(){slide("home","home")},""),document.title="Library",swap(title,"Library",.35);break;case"collection":setBack(function(){slide("library","lib")},"Library"),document.title=e.name||"Collection",swap(title,e.name||"Collection",.35),curCollection=e,a&&collectionCatalog();break;case"book":if(short)var i=curCollection.short;setBack(function(){slide("collection","lib",curCollection,!1)},i||curCollection.name),document.title=e.name||"Book",swap(title,e.name||"Book",.35),curBook=e,curPart={id:"SKIP"},a&&bookCatalog();break;case"part":setBack(function(){slide("book",null,curBook,!1)},curBook.short||curBook.name),document.title=e.name||"Part",swap(title,e.name||"Part",.35),curPart=e,a&&partCatalog();break;case"reader":document.getElementById("progress").style.opacity="1";var d=e.name,c="";if(short)var o=curPart.short;curPart.id=="SKIP"?c=curBook.short||curBook.name:c=o||curPart.name,e.short&&(d=curPart.name+" "+e.short,c=""),curPart.id=="SKIP"?setBack(function(){slide("book",null,curBook,!1)},c):setBack(function(){slide("part",null,curPart,!1)},c),document.title=d,swap(title,d||"Chapter",.35),curChapter=e,a&&(reader.scrollTop=0,document.getElementById("progress").style.width="",chapterCatalog(e.id));break;case"inspector":document.getElementById("progress").style.opacity="1",setTimeout(function(){document.getElementById("content").addEventListener("click",closeInspector)},0);var d=curChapter.name;curChapter.short&&(d=(curPart.short||curPart.name)+" "+curChapter.short),setBack(function(){closeInspector(),slide("reader",null,curChapter,!1)},d),swap(title,e||"Inspector",.35);break;default:document.title="Sprym",swap(title,"Sprym",.35)}}function libCatalog(){readBinaryFile("library/"+lang+"/library.scl",function(n,t){var e=document.getElementById("collections");if(n){e.innerHTML="";for(var a of t){var r=document.createElement("li"),l=document.createElement("img");l.loading="lazy",l.src="library/"+(a.imgLang?lang+"/":"")+a.id+".jpg",l.srcset="library/"+(a.imgLang?lang+"/":"")+a.id+"@2x.jpg 2x, library/"+(a.imgLang?lang+"/":"")+a.id+"@3x.jpg 3x",l.addEventListener("error",function(){this.removeEventListener("error",arguments.callee),this.removeAttribute("srcset"),this.addEventListener("error",function(){this.removeEventListener("error",arguments.callee),this.src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22/%3E"})});var i=document.createElement("p");i.textContent=a.name,function(){var u=a;r.addEventListener("click",function(){slide("collection","lib",u,document.getElementById("books").innerHTML==""||curCollection&&u.id!=curCollection.id)})}(),r.appendChild(l),r.appendChild(i),e.appendChild(r)}libraryCache=t}else{var c=document.createElement("div"),o=document.createElement("h2");if(c.id="error",o.textContent="Unable to Load Library",t)c.appendChild(o);else{var d=document.createElement("button");d.textContent="Try Again",d.id="action",c.appendChild(o),c.appendChild(d)}e.innerHTML=c.outerHTML,t||(document.getElementById("action").addEventListener("click",function(){libCatalog(),slide("library","lib")}),setTimeout(function(){document.getElementById("lib-btn").addEventListener("click",function(){this.removeEventListener("click",arguments.callee),libCatalog()})},0))}})}function collectionCatalog(){var n;for(var t of libraryCache)if(t.id==curCollection.id){n=t.books;break}if(n&&n.length>0){for(var e=document.getElementById("books");e.firstChild;)e.removeChild(e.lastChild);for(var a of n){var r=document.createElement("li"),l=document.createElement("img"),i=document.createElement("p");l.loading="lazy",l.src="library/"+lang+"/"+a+".spr/cover.jpg",l.srcset="library/"+lang+"/"+a+".spr/cover@2x.jpg 2x, library/"+lang+"/"+a+".spr/cover@3x.jpg 3x",l.addEventListener("error",function(){this.removeEventListener("error",arguments.callee),this.removeAttribute("srcset"),this.addEventListener("error",function(){this.removeEventListener("error",arguments.callee),this.src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22/%3E"})}),r.appendChild(l),function(){var c=a,o=r,d=i;readBinaryFile("library/"+lang+"/"+a+".spr/book.stc",function(u,m){u?(d.textContent=m.name,o.addEventListener("click",function(){slide("book",null,m,document.getElementById("parts").innerHTML==""||c!=curBook.id)}),o.appendChild(d)):(e.removeChild(o),e.children.length<=0&&(curCollection=null,back.click(),notify("error","No Books Found","No books were found in this collection.",{OK:null})))})}(),e.appendChild(r)}collectionCache=n}else curCollection=null,back.click(),notify("error","No Books Found","No books were found in this collection.",{OK:null})}function bookCatalog(){for(var n=document.getElementById("parts");n.firstChild;)n.removeChild(n.lastChild);for(var t=document.getElementById("chapters");t.firstChild;)t.removeChild(t.lastChild);for(var e=document.getElementById("article");e.firstChild;)e.removeChild(e.lastChild);noteCache=null,readBinaryFile("library/"+lang+"/"+curBook.id+".spr/book.stc",function(a,r){if(a)if(r.parts&&r.parts.length>0){for(var l of r.parts){var i=document.createElement("li"),c=document.createElement("p"),o=document.createTextNode(l.name);if(l.before){var d=document.createElement("span");d.textContent=l.before,c.appendChild(d)}if(c.appendChild(o),l.after){var u=document.createElement("span");u.textContent=l.after,c.appendChild(u)}(function(){var m=l;m.chapters?i.addEventListener("click",function(){slide("part",null,m,document.getElementById("chapters").innerHTML==""||m.id!=(curPart.id||""))}):(i.classList.add("chapter"),i.addEventListener("click",function(){slide("reader",null,m)}))})(),i.appendChild(c),n.appendChild(i)}bookCache=r.parts}else back.click(),notify("error","Contents Not Found","No content could be located in the table of contents.",{OK:null});else back.click(),notify("error","Unable to Load Contents","The table of contents could not be loaded. Please check your network connection or try again later.",{OK:null})})}function partCatalog(){var n,t=document.getElementById("chapters");for(var e of bookCache)if(e.id==curPart.id){t.classList=e.type||"list",n=e.chapters;break}if(n&&n.length>0){for(;t.firstChild;)t.removeChild(t.lastChild);for(var a=document.getElementById("article");a.firstChild;)a.removeChild(a.lastChild);noteCache=null;for(var r of n){var l=document.createElement("li"),i=document.createElement("p"),c=document.createTextNode(r.name);if(r.before){var o=document.createElement("span");o.textContent=r.before,i.appendChild(o)}if(i.appendChild(c),r.after){var d=document.createElement("span");d.textContent=r.after,i.appendChild(d)}(function(){var u=r;l.addEventListener("click",function(){slide("reader",null,u,document.getElementById("article").innerHTML==""||u.id!=(curChapter.id||""))})})(),l.appendChild(i),t.appendChild(l)}partCache=n}else back.click(),notify("error","No Chapters Found","No chapters were found in this part.",{OK:null})}function chapterCatalog(n){for(var t=document.getElementById("article");t.firstChild;)t.removeChild(t.lastChild);if(noteCache=null,n=="stp")document.getElementById("head").style.display="none",function(){readBinaryFile("library/"+lang+"/"+curBook.id+".spr/book.stp",function(a,r){if(a)for(var l of r){var i=document.createElement("p");if(i.classList.add("tp"),l.length==1&&l[0].type=="normal")i.textContent=l[0].content;else for(var c of l){switch(c.type){case"title":var o=document.createElement("h2");break;case"heading":var o=document.createElement("h3");break;case"subheading":var o=document.createElement("h4");break;case"small":var o=document.createElement("small");break;default:var o=document.createElement("span")}o.textContent=c.content,i.appendChild(o)}document.getElementById("article").appendChild(i)}})}();else if(curPart.id=="SKIP")document.getElementById("chapter").style.display="none",document.getElementById("summary").style.display="none",document.getElementById("head").style.display="",document.getElementById("heading").textContent=curChapter.title||curChapter.name,document.getElementById("subheading").textContent=curChapter.subtitle||"",document.getElementById("intro").textContent=curChapter.intro||"",document.getElementById("superhead").style.display="",function(){var a=curChapter;readFile("library/"+lang+"/"+curBook.id+".spr/"+curChapter.id+".sch",function(r,l){if(r){var i=document.createElement("ol");parse(i,a.type,l),document.getElementById("article").appendChild(i)}else notify("error","Unable to Load Chapter","The chapter could not be loaded. Please check your network connection or try again later.",{OK:null})})}();else{document.getElementById("head").style.display="";for(var e of partCache)e.id==curChapter.id&&(e.first==!0?(document.getElementById("heading").textContent=curPart.title||"",document.getElementById("subheading").textContent=curPart.subtitle||"",document.getElementById("intro").textContent=curPart.intro||"",document.getElementById("superhead").style.display=""):document.getElementById("superhead").style.display="none",document.getElementById("chapter").style.display="",document.getElementById("summary").style.display="",document.getElementById("chapter").textContent=e.title||e.name,document.getElementById("summary-text").textContent=e.summary||"",function(){var a=e;readFile("library/"+lang+"/"+curBook.id+".spr/"+curPart.id+"/"+curChapter.id+".sch",function(r,l){if(r){var i=document.createElement("ol");parse(i,a.type,l),document.getElementById("article").appendChild(i)}else notify("error","Unable to Load Chapter","The chapter could not be loaded. Please check your network connection or try again later.",{OK:null})})}())}}function parseNote(n,t){if(t.note){var e=document.createElement("li");e.textContent=t.note,n.appendChild(e)}if(t.ie){var e=document.createElement("li");e.textContent="IE "+t.ie,n.appendChild(e)}if(t.greek){var e=document.createElement("li");e.textContent="GR "+t.greek,n.appendChild(e)}if(t.jst){for(var e=document.createElement("li");match=/`(.*?)`/g.exec(t.jst);)t.jst=t.jst.replace(match[0],"<em>"+match[1]+"</em>");e.innerHTML="JST "+t.jst,n.appendChild(e)}if(t.cross)for(var a of t.cross){var e=document.createElement("li");e.textContent=a,n.appendChild(e)}if(t.tg)for(var a of t.tg){var e=document.createElement("li");e.textContent="TG "+a,n.appendChild(e)}}function note(n){for(var t=n.id.slice(1),e="",a=n.childNodes,r=0;r<a.length;r++)if(a[r].nodeType==Node.TEXT_NODE){e=a[r].nodeValue;break}slide("inspector",null,t),document.getElementById("inspector-title").textContent=e;for(var l=document.getElementById("notes");l.firstChild;)l.removeChild(l.lastChild);noteCache?parseNote(l,noteCache[t]):function(){var i=l,c=t;readBinaryFile("library/"+lang+"/"+curBook.id+".spr/"+curPart.id+"/"+curChapter.id+".snn",function(o,d){o?(parseNote(i,d[c]),noteCache=d):(back.click(),notify("error","Unable to Load Notes","The notes could not be loaded. Please check your network connection or try again later.",{OK:null}))})}()}function touchStart(n,t){t.x=n.touches[0].clientX,t.y=n.touches[0].clientY}function touchEnd(n,t,e){if(!(!t.x||!t.y)){var a=t.x-n.changedTouches[0].clientX,r=(t.y-n.changedTouches[0].clientY)*1.25;Math.abs(a)>Math.abs(r)?a>=10?e[1]&&e[1](t.x>=document.body.clientWidth-25):a<=10&&e[0]&&e[0](t.x<=25):e.length>2&&Math.abs(r)>Math.abs(a)&&(r>=10?e[2]&&e[2](t.y>=document.body.clientHeight-25):r<=10&&e[3]&&e[3](t.y<=25)),t.x=null,t.y=null}}document.getElementById("content").addEventListener("touchstart",function(n){touchStart(n,contentTouch)}),document.getElementById("content").addEventListener("touchend",function(n){touchEnd(n,contentTouch,[function(t){(t||document.getElementById("reader").classList.contains("hidden"))&&(closeInspector(),back.click())},null])}),document.getElementById("modal").addEventListener("touchstart",function(n){!window.matchMedia("(max-height: 600px)").matches&&(n.target.closest("#modal-header")||document.getElementById("modal-content").scrollTop<=0)&&touchStart(n,modalTouch)}),document.getElementById("modal").addEventListener("touchend",function(n){!window.matchMedia("(max-height: 600px)").matches&&(n.target.closest("#modal-header")||document.getElementById("modal-content").scrollTop<=0)&&touchEnd(n,modalTouch,[null,null,null,function(){document.body.classList.remove("modal")}])});function menu(n){var t=document.getElementById(n);t.classList.contains("open")?t.classList.remove("open"):(t.classList.add("open"),setTimeout(function(){document.addEventListener("click",function(e){!e.target.closest(n)&&e.target.tagName.toLowerCase()!="hr"&&(this.removeEventListener("click",arguments.callee),t.classList.remove("open"))})},0))}function modal(n){document.getElementById("modal-title").textContent=document.getElementById(n).dataset.title;for(var t=document.getElementById("modal-content").children,e=0;e<t.length;e++)t[e].id==n?t[e].style.display="":t[e].style.display="none";document.body.classList.add("modal")}
